<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonix â€” Material 3 Music</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --primary: #D0BCFF;
            --on-primary: #381E72;
            --primary-container: #4F378B;
            --on-primary-container: #EADDFF;
            --surface: #141218;
            --on-surface: #E6E1E5;
            --surface-variant: #49454F;
            --on-surface-variant: #CAC4D0;
            --outline: #938F99;
            --surface-container: #1D1B20;
            --p: 0%; 
            --v: 80%;
        }

        body.light-mode {
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --primary-container: #EADDFF;
            --on-primary-container: #21005D;
            --surface: #FEF7FF;
            --on-surface: #1D1B20;
            --surface-variant: #E7E0EB;
            --on-surface-variant: #49454F;
            --surface-container: #F3EDF7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Google Sans', sans-serif;
            background-color: var(--surface);
            color: var(--on-surface);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        /* Splash Screen */
        #splash {
            position: fixed; inset: 0;
            background: var(--surface); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: 0.5s ease;
        }

        /* App Bar */
        .app-bar {
            padding: 16px 24px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }
        .app-title { font-size: 22px; font-weight: 500; color: var(--primary); }

        /* Navigation */
        .nav-bar {
            display: flex; justify-content: space-around;
            padding: 12px; background: var(--surface-container);
            border-radius: 32px; margin: 0 20px 10px;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; 
            gap: 4px; font-size: 12px; cursor: pointer; color: var(--on-surface-variant);
        }
        .nav-item.active { color: var(--primary); }
        .nav-item .material-symbols-rounded {
            padding: 4px 20px; border-radius: 16px; transition: 0.3s;
        }
        .nav-item.active .material-symbols-rounded { background: var(--primary-container); color: var(--on-primary-container); }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 0 20px 180px; scrollbar-width: none; }
        main::-webkit-scrollbar { display: none; }

        /* Search Section */
        .search-container {
            position: sticky; top: 0; background: var(--surface); padding: 10px 0; z-index: 5;
        }
        .search-bar {
            background: var(--surface-container); border-radius: 28px;
            display: flex; align-items: center; padding: 0 16px; height: 56px;
        }
        .search-bar input {
            flex: 1; background: transparent; border: none; color: var(--on-surface);
            font-size: 16px; margin-left: 12px; outline: none;
        }

        /* Grid Results */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px; margin-top: 20px;
        }
        .card {
            background: var(--surface-container); padding: 12px; border-radius: 24px;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .card:hover { background: var(--surface-variant); }
        .card img { width: 100%; aspect-ratio: 1; border-radius: 16px; object-fit: cover; }
        .card .title { font-size: 14px; font-weight: 500; margin-top: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .artist { font-size: 12px; opacity: 0.6; }
        .card .like-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.4); border-radius: 50%; padding: 4px; color: white; display: none; }
        .card:hover .like-btn { display: block; }

        /* Player Dock */
        #player {
            position: fixed; bottom: 85px; left: 10px; right: 10px;
            background: var(--primary-container); color: var(--on-primary-container);
            border-radius: 24px; padding: 12px 16px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            transform: translateY(200%); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        #player.active { transform: translateY(0); }
        .p-art { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; }
        .p-info { flex: 1; min-width: 0; }
        .p-info h4 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-info p { margin: 0; font-size: 12px; opacity: 0.8; }

        /* Expanded Player */
        #expandedPlayer {
            position: fixed; inset: 0; background: var(--surface);
            z-index: 2000; display: none; flex-direction: column; padding: 40px 24px;
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .ex-art { width: 100%; aspect-ratio: 1; border-radius: 32px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); margin-bottom: 40px; }
        .ex-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        
        /* Progress Bar */
        .progress-container { width: 100%; margin: 20px 0; }
        .slider {
            -webkit-appearance: none; width: 100%; height: 4px; border-radius: 2px;
            background: linear-gradient(to right, var(--primary) var(--p), var(--surface-variant) var(--p));
            outline: none; cursor: pointer;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--primary);
        }

        /* Controls */
        .btn-group { display: flex; align-items: center; justify-content: center; gap: 24px; }
        .icon-btn { 
            background: none; border: none; color: var(--on-surface); cursor: pointer;
            display: flex; align-items: center; justify-content: center; border-radius: 50%;
        }
        .play-big { background: var(--primary-container); color: var(--on-primary-container); width: 72px; height: 72px; border-radius: 24px; }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--on-surface); color: var(--surface);
            padding: 12px 24px; border-radius: 30px; font-size: 14px; opacity: 0; transition: 0.3s;
        }

        /* Utilities */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="splash">
        <span class="material-symbols-rounded" style="font-size: 80px; color: var(--primary);">library_music</span>
        <h2 style="letter-spacing: 4px; font-weight: 400;">HARMONIX</h2>
    </div>

    <div class="app-bar">
        <span class="app-title">Harmonix</span>
        <button class="icon-btn" onclick="toggleTheme()"><span class="material-symbols-rounded" id="themeIcon">dark_mode</span></button>
    </div>

    <main id="mainContent">
        <div class="search-container">
            <div class="search-bar">
                <span class="material-symbols-rounded">search</span>
                <input type="text" id="searchInput" placeholder="Search songs, artists...">
            </div>
        </div>

        <div id="homeSection">
            <h3 id="gridTitle">Recent Discoveries</h3>
            <div class="grid" id="musicGrid"></div>
        </div>
    </main>

    <!-- Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="showSection('home')">
            <span class="material-symbols-rounded">home</span>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="showSection('liked')">
            <span class="material-symbols-rounded">favorite</span>
            <span>Liked</span>
        </div>
        <div class="nav-item" onclick="showSection('history')">
            <span class="material-symbols-rounded">history</span>
            <span>History</span>
        </div>
    </div>

    <!-- Mini Player -->
    <div id="player" onclick="expandPlayer(true)">
        <img src="" id="miniArt" class="p-art">
        <div class="p-info">
            <h4 id="miniTitle">Song Title</h4>
            <p id="miniArtist">Artist Name</p>
        </div>
        <button class="icon-btn" onclick="event.stopPropagation(); togglePlay()">
            <span class="material-symbols-rounded" id="miniPlayIcon">play_arrow</span>
        </button>
    </div>

    <!-- Full Screen Player -->
    <div id="expandedPlayer">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <button class="icon-btn" onclick="expandPlayer(false)"><span class="material-symbols-rounded">expand_more</span></button>
            <span style="font-weight: 500; font-size: 14px;">NOW PLAYING</span>
            <button class="icon-btn" id="likeBtnPlayer" onclick="toggleLikeCurrent()"><span class="material-symbols-rounded">favorite</span></button>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <img src="" id="exArt" class="ex-art">
            <h2 id="exTitle" style="margin:0 0 8px">Song Title</h2>
            <p id="exArtist" style="margin:0; opacity:0.7; font-size:18px">Artist Name</p>

            <div class="progress-container">
                <input type="range" class="slider" id="progSeek" value="0" step="0.1">
                <div style="display:flex; justify-content: space-between; margin-top:8px; font-family:'Roboto Mono'; font-size:12px">
                    <span id="curTime">0:00</span>
                    <span id="totTime">0:00</span>
                </div>
            </div>

            <div class="ex-controls">
                <button class="icon-btn" onclick="toggleShuffle()"><span class="material-symbols-rounded" id="shuffIcon">shuffle</span></button>
                <div class="btn-group">
                    <button class="icon-btn" onclick="prevSong()"><span class="material-symbols-rounded" style="font-size:32px">skip_previous</span></button>
                    <button class="icon-btn play-big" onclick="togglePlay()"><span class="material-symbols-rounded" style="font-size:48px" id="exPlayIcon">play_arrow</span></button>
                    <button class="icon-btn" onclick="nextSong()"><span class="material-symbols-rounded" style="font-size:32px">skip_next</span></button>
                </div>
                <button class="icon-btn" onclick="toggleRepeat()"><span class="material-symbols-rounded" id="repIcon">repeat</span></button>
            </div>
            
            <div style="display:flex; justify-content: space-around; margin-top: 40px;">
                <button class="icon-btn" onclick="downloadCurrent()"><span class="material-symbols-rounded">download</span></button>
                <button class="icon-btn" onclick="showToast('Lyrics coming soon!')"><span class="material-symbols-rounded">notes</span></button>
                <button class="icon-btn" onclick="shareSong()"><span class="material-symbols-rounded">share</span></button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Message</div>
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        const API = "https://jiosaavn-api.bhargavtodimela4.workers.dev/api/search/songs?query=";
        const audio = document.getElementById('audio');
        let queue = [];
        let currentIndex = -1;
        let likedSongs = JSON.parse(localStorage.getItem('liked_songs')) || [];
        let history = JSON.parse(localStorage.getItem('search_history')) || [];
        let isShuffle = false;
        let repeatMode = 0; // 0: None, 1: One, 2: All

        // Init
        window.onload = () => {
            if(localStorage.getItem('theme') === 'light') toggleTheme();
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').style.display = 'none', 500);
            }, 1500);
            searchSongs('New Hindi'); // Default results
        };

        // Theme
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('themeIcon').innerText = isLight ? 'light_mode' : 'dark_mode';
        }

        // Search Logic
        const searchInput = document.getElementById('searchInput');
        searchInput.onkeydown = (e) => {
            if(e.key === 'Enter') {
                searchSongs(searchInput.value);
                saveHistory(searchInput.value);
            }
        };

        async function searchSongs(query) {
            if(!query) return;
            try {
                const res = await fetch(API + encodeURIComponent(query));
                const json = await res.json();
                queue = json.data.results.map(s => ({
                    id: s.id,
                    title: cleanText(s.name),
                    artist: cleanText(s.artists.primary[0].name),
                    image: s.image[s.image.length-1].url,
                    url: s.downloadUrl[s.downloadUrl.length-1].url
                }));
                renderGrid(queue);
                document.getElementById('gridTitle').innerText = `Results for "${query}"`;
            } catch (e) {
                showToast("Error fetching songs");
            }
        }

        function renderGrid(list) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = list.map((s, i) => `
                <div class="card" onclick="playSong(${i})">
                    <img src="${s.image}" loading="lazy">
                    <button class="icon-btn like-btn" onclick="event.stopPropagation(); toggleLike('${s.id}')">
                        <span class="material-symbols-rounded">${isLiked(s.id) ? 'favorite' : 'favorite_border'}</span>
                    </button>
                    <div class="title">${s.title}</div>
                    <div class="artist">${s.artist}</div>
                </div>
            `).join('');
        }

        // Player Logic
        function playSong(index) {
            currentIndex = index;
            const song = queue[currentIndex];
            audio.src = song.url;
            audio.play();

            // UI Updates
            document.getElementById('player').classList.add('active');
            updatePlayerUI(song);
            
            // Media Session
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title, artist: song.artist,
                    artwork: [{ src: song.image, sizes: '512x512', type: 'image/jpeg' }]
                });
            }
        }

        function updatePlayerUI(song) {
            // Mini Player
            document.getElementById('miniArt').src = song.image;
            document.getElementById('miniTitle').innerText = song.title;
            document.getElementById('miniArtist').innerText = song.artist;
            document.getElementById('miniPlayIcon').innerText = 'pause';

            // Expanded Player
            document.getElementById('exArt').src = song.image;
            document.getElementById('exTitle').innerText = song.title;
            document.getElementById('exArtist').innerText = song.artist;
            document.getElementById('exPlayIcon').innerText = 'pause';
            document.getElementById('likeBtnPlayer').style.color = isLiked(song.id) ? 'var(--primary)' : 'var(--on-surface)';
        }

        function togglePlay() {
            if(audio.paused) {
                audio.play();
                document.getElementById('miniPlayIcon').innerText = 'pause';
                document.getElementById('exPlayIcon').innerText = 'pause';
            } else {
                audio.pause();
                document.getElementById('miniPlayIcon').innerText = 'play_arrow';
                document.getElementById('exPlayIcon').innerText = 'play_arrow';
            }
        }

        function nextSong() {
            if(isShuffle) {
                currentIndex = Math.floor(Math.random() * queue.length);
            } else {
                currentIndex = (currentIndex + 1) % queue.length;
            }
            playSong(currentIndex);
        }

        function prevSong() {
            currentIndex = (currentIndex - 1 + queue.length) % queue.length;
            playSong(currentIndex);
        }

        // Audio Events
        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100 || 0;
            document.documentElement.style.setProperty('--p', p + '%');
            document.getElementById('progSeek').value = p;
            document.getElementById('curTime').innerText = formatTime(audio.currentTime);
            document.getElementById('totTime').innerText = formatTime(audio.duration);
        };

        audio.onended = () => {
            if(repeatMode === 1) { audio.currentTime = 0; audio.play(); }
            else if(repeatMode === 2 || currentIndex < queue.length - 1) nextSong();
        };

        document.getElementById('progSeek').oninput = (e) => {
            audio.currentTime = (e.target.value / 100) * audio.duration;
        };

        // UI Helpers
        function expandPlayer(show) {
            document.getElementById('expandedPlayer').style.display = show ? 'flex' : 'none';
        }

        function formatTime(s) {
            if(isNaN(s)) return '0:00';
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60).toString().padStart(2,'0');
            return `${m}:${sec}`;
        }

        function cleanText(text) {
            const div = document.createElement('div');
            div.innerHTML = text;
            return div.textContent || div.innerText || "";
        }

        // Feature: Likes
        function toggleLike(id) {
            const song = queue.find(s => s.id === id);
            const idx = likedSongs.findIndex(s => s.id === id);
            if(idx > -1) likedSongs.splice(idx, 1);
            else likedSongs.push(song);
            localStorage.setItem('liked_songs', JSON.stringify(likedSongs));
            renderGrid(queue);
            showToast(idx > -1 ? "Removed from Likes" : "Added to Likes");
        }

        function toggleLikeCurrent() {
            if(currentIndex === -1) return;
            toggleLike(queue[currentIndex].id);
            updatePlayerUI(queue[currentIndex]);
        }

        function isLiked(id) { return likedSongs.some(s => s.id === id); }

        // Feature: Sections
        function showSection(type) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(type === 'liked') {
                queue = [...likedSongs];
                renderGrid(queue);
                document.getElementById('gridTitle').innerText = "Your Liked Songs";
            } else if(type === 'history') {
                document.getElementById('gridTitle').innerText = "Search History (Last 5)";
                document.getElementById('musicGrid').innerHTML = history.slice(-5).map(h => `
                    <div class="card" onclick="searchSongs('${h}')" style="height:80px; display:flex; align-items:center;">
                        <span class="material-symbols-rounded" style="margin-right:15px">history</span>
                        <span>${h}</span>
                    </div>
                `).join('');
            } else {
                searchSongs('New Hindi');
            }
        }

        function saveHistory(q) {
            if(!history.includes(q)) {
                history.push(q);
                localStorage.setItem('search_history', JSON.stringify(history));
            }
        }

        // Feature: Download
        async function downloadCurrent() {
            if(currentIndex === -1) return;
            const song = queue[currentIndex];
            showToast("Preparing download...");
            try {
                const res = await fetch(song.url);
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${song.title}.mp3`;
                a.click();
            } catch(e) { showToast("Download failed"); }
        }

        // Shuffle & Repeat UI
        function toggleShuffle() {
            isShuffle = !isShuffle;
            document.getElementById('shuffIcon').style.color = isShuffle ? 'var(--primary)' : 'inherit';
            showToast(isShuffle ? "Shuffle On" : "Shuffle Off");
        }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const icons = ['repeat', 'repeat_one', 'repeat'];
            document.getElementById('repIcon').innerText = icons[repeatMode];
            document.getElementById('repIcon').style.color = repeatMode > 0 ? 'var(--primary)' : 'inherit';
            const labels = ["Off", "One", "All"];
            showToast("Repeat: " + labels[repeatMode]);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        function shareSong() {
            if (navigator.share && currentIndex !== -1) {
                navigator.share({
                    title: queue[currentIndex].title,
                    text: `Check out ${queue[currentIndex].title} on Harmonix`,
                    url: window.location.href
                });
            }
        }
    </script>
</body>
</html>
