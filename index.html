<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Infinity â€” Final Master</title>
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://c.saavncdn.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --primary: #D0BCFF;
            --on-primary: #381E72;
            --primary-container: #4F378B;
            --surface: #0A0A0C;
            --on-surface: #E6E1E5;
            --surface-variant: rgba(255, 255, 255, 0.12);
            --glass: rgba(18, 18, 22, 0.85);
            --progress: 0%;
            --apple-ease: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body.light-mode {
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --primary-container: #EADDFF;
            --surface: #F5F5F7;
            --on-surface: #1C1B1F;
            --surface-variant: rgba(0, 0, 0, 0.08);
            --glass: rgba(255, 255, 255, 0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Google Sans', sans-serif;
            background-color: var(--surface);
            color: var(--on-surface);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            transition: background 0.5s ease;
        }

        /* Material Icons Visibility Fix */
        .material-symbols-rounded {
            color: var(--on-surface);
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            transition: color 0.3s ease;
        }
        .primary-icon { color: var(--primary) !important; }

        /* Internet Status */
        #offlineBanner {
            position: fixed; top: 0; left: 0; width: 100%;
            background: #B00020; color: white; padding: 10px;
            text-align: center; font-size: 11px; font-weight: 700;
            z-index: 10001; transform: translateY(-100%); transition: 0.4s var(--apple-ease);
        }
        #offlineBanner.show { transform: translateY(0); }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 3px;
            background: transparent; z-index: 9999; overflow: hidden; display: none;
        }
        #loader.active { display: block; }
        .loader-fill { width: 40%; height: 100%; background: var(--primary); position: absolute; left: -40%; animation: flow 1.2s infinite linear; }
        @keyframes flow { from { left: -40%; } to { left: 100%; } }

        /* Header */
        header { 
            padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; 
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            background: var(--glass); position: sticky; top: 0; z-index: 100;
        }
        .brand { font-size: 22px; font-weight: 700; color: var(--primary); letter-spacing: -1.5px; }
        .status-badge { 
            display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700;
            background: var(--surface-variant); padding: 6px 14px; border-radius: 20px;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; transition: 0.3s; }
        .dot.online { background: #34C759; box-shadow: 0 0 10px #34C759; }
        .dot.offline { background: #FF3B30; }

        /* Content Area */
        main { height: calc(100vh - 70px); overflow-y: auto; padding: 20px 20px 200px; scrollbar-width: none; }
        main::-webkit-scrollbar { display: none; }

        .search-bar { 
            background: var(--surface-variant); border-radius: 20px; height: 56px;
            display: flex; align-items: center; padding: 0 20px;
            transition: 0.4s var(--apple-ease); margin-bottom: 20px;
        }
        .search-bar:focus-within { background: var(--surface); box-shadow: 0 0 0 2px var(--primary); }
        .search-bar input { flex: 1; background: none; border: none; color: var(--on-surface); font-size: 16px; margin-left: 12px; }

        .chips { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; margin-bottom: 25px; }
        .chip { background: var(--surface-variant); padding: 10px 20px; border-radius: 14px; font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.3s; color: var(--on-surface); }
        .chip.active { background: var(--primary); color: var(--on-primary); }

        /* Song Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 18px; }
        .card { 
            background: var(--surface-variant); border-radius: 28px; padding: 12px;
            transition: 0.4s var(--apple-ease); cursor: pointer; position: relative;
        }
        .card:hover { transform: translateY(-8px) scale(1.02); background: rgba(120, 120, 150, 0.2); }
        .card img { width: 100%; aspect-ratio: 1; border-radius: 20px; object-fit: cover; margin-bottom: 10px; }
        
        .card-dl { 
            position: absolute; top: 18px; right: 18px; width: 40px; height: 40px;
            background: var(--primary); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            z-index: 5; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .card-dl .material-symbols-rounded { color: var(--on-primary); }

        .card .t { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--on-surface); }
        .card .a { font-size: 12px; opacity: 0.6; color: var(--on-surface); }

        /* Floating Mini Player */
        #miniPlayer {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(250%);
            width: calc(100% - 40px); max-width: 550px; height: 76px;
            background: var(--glass); backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px);
            border-radius: 24px; display: flex; align-items: center; padding: 0 16px; gap: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.6); z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1); transition: transform 0.6s var(--apple-ease);
        }
        #miniPlayer.active { transform: translateX(-50%) translateY(0); }
        .m-art { width: 52px; height: 52px; border-radius: 12px; object-fit: cover; }
        .m-info { flex: 1; overflow: hidden; }
        .m-info h4 { margin: 0; font-size: 14px; font-weight: 700; color: var(--on-surface); }

        /* Expanded Player UI */
        #fullPlayer {
            position: fixed; inset: 0; background: var(--surface); z-index: 2000;
            display: none; flex-direction: column; padding: 40px 30px;
            transition: background 0.8s var(--apple-ease);
        }
        .f-nav { display: flex; justify-content: space-between; align-items: center; }
        .f-nav .material-symbols-rounded { font-size: 32px; }

        .f-art-wrap { flex: 1; display: flex; align-items: center; justify-content: center; }
        .f-img { width: 85vw; max-width: 350px; aspect-ratio: 1; border-radius: 35px; box-shadow: 0 40px 100px rgba(0,0,0,0.7); }
        
        .f-meta { text-align: left; width: 100%; max-width: 450px; margin: 0 auto 20px; }
        .f-meta h2 { margin: 0; font-size: 28px; font-weight: 700; color: var(--on-surface); }
        .f-meta p { margin: 6px 0 0; font-size: 18px; color: var(--primary); font-weight: 500; }

        .controls-card {
            background: var(--surface-variant); backdrop-filter: blur(20px);
            padding: 30px; border-radius: 35px; width: 100%; max-width: 500px;
            margin: 0 auto; border: 1px solid rgba(255,255,255,0.1);
        }
        .slider { 
            -webkit-appearance: none; width: 100%; height: 6px; border-radius: 10px;
            background: linear-gradient(to right, var(--primary) var(--progress), rgba(255,255,255,0.1) var(--progress));
            outline: none; cursor: pointer;
        }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: white; border-radius: 50%; box-shadow: 0 0 15px rgba(0,0,0,0.5); }

        .f-btns { display: flex; justify-content: space-between; align-items: center; margin: 25px 0; }
        .play-big { 
            width: 80px; height: 80px; border-radius: 50%; background: var(--primary);
            color: var(--on-primary); display: flex; align-items: center; justify-content: center;
        }
        .play-big .material-symbols-rounded { color: var(--on-primary) !important; font-size: 55px; }

        /* Toast & Modal */
        #toast { 
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: var(--on-surface); color: var(--surface);
            padding: 12px 30px; border-radius: 40px; font-weight: 700;
            opacity: 0; transition: 0.4s var(--apple-ease); z-index: 9999;
        }
        #modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px);
            z-index: 11000; display: none; align-items: center; justify-content: center; padding: 30px;
        }
        .modal-card { background: var(--glass); padding: 40px; border-radius: 35px; max-width: 450px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .btn-filled { background: var(--primary); color: var(--on-primary); border: none; padding: 14px 40px; border-radius: 20px; font-weight: 700; cursor: pointer; margin-top: 20px; }

        footer { text-align: center; padding: 60px 0; font-size: 12px; opacity: 0.4; font-weight: 700; border-top: 1px solid rgba(255,255,255,0.1); }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 10px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="offlineBanner">OFFLINE: PLAYBACK & SEARCH ARE LIMITED</div>
    <div id="loader"><div class="loader-fill"></div></div>

    <header>
        <div class="brand">AURA</div>
        <div class="status-badge" id="netStatus"><div class="dot online"></div> ONLINE</div>
        <button class="icon-btn" onclick="toggleTheme()"><span class="material-symbols-rounded" id="themeIcon">dark_mode</span></button>
    </header>

    <main>
        <div class="search-area">
            <div class="search-bar">
                <span class="material-symbols-rounded primary-icon">search</span>
                <input type="text" id="searchInp" placeholder="Search for tracks, artists..." autocomplete="off">
            </div>
            <div class="chips">
                <div class="chip active" onclick="search('Trending Hindi Mix', this)">Trending</div>
                <div class="chip" onclick="search('English Pop 2024', this)">Global Pop</div>
                <div class="chip" onclick="search('Lo-fi Focus Mix', this)">Lo-fi Focus</div>
                <div class="chip" onclick="search('90s Bollywood gold', this)">90s Classics</div>
            </div>
        </div>
        <div class="grid" id="mainGrid"></div>
        <footer>
            MADE BY BHARGAV TODIMELA<br><br>
            <span style="text-decoration: underline; cursor:pointer;" onclick="toggleModal(true)">DISCLAIMER</span>
        </footer>
    </main>

    <!-- Mini Player -->
    <div id="miniPlayer" onclick="expandPlayer(true)">
        <img src="" id="mArt" class="m-art">
        <div class="m-info"><h4 id="mTitle">Not Playing</h4><span id="mArtist" style="font-size:12px;opacity:0.6">Ready to play</span></div>
        <button class="icon-btn" onclick="event.stopPropagation(); togglePlay()"><span class="material-symbols-rounded primary-icon" id="mPlayIcon" style="font-size:45px">play_arrow</span></button>
    </div>

    <!-- Full Player -->
    <div id="fullPlayer">
        <div class="f-nav">
            <button class="icon-btn" onclick="expandPlayer(false)"><span class="material-symbols-rounded">expand_more</span></button>
            <span style="font-size:12px; font-weight:700; opacity:0.4; letter-spacing:2px">NOW PLAYING</span>
            <button class="icon-btn" onclick="downloadCurrent()"><span class="material-symbols-rounded">download</span></button>
        </div>

        <div class="f-art-wrap"><img src="" id="fArt" class="f-img"></div>
        <div class="f-meta"><h2 id="fTitle">Song Title</h2><p id="fArtist">Artist Name</p></div>

        <div class="controls-card">
            <div class="seeker-box">
                <input type="range" class="slider" id="seeker" value="0">
                <div style="display:flex; justify-content: space-between; margin-top:12px; font-family:'Roboto Mono'; font-size:12px; opacity:0.6; font-weight:700">
                    <span id="curT">0:00</span><span id="totT">0:00</span>
                </div>
            </div>

            <div class="f-btns">
                <button class="icon-btn" onclick="toggleShuffle()"><span class="material-symbols-rounded">shuffle</span></button>
                <div style="display:flex; align-items:center; gap:15px">
                    <button class="icon-btn" onclick="prev()"><span class="material-symbols-rounded" style="font-size:48px">skip_previous</span></button>
                    <div class="play-big" onclick="togglePlay()"><span class="material-symbols-rounded" id="fPlayIcon">play_arrow</span></div>
                    <button class="icon-btn" onclick="next()"><span class="material-symbols-rounded" style="font-size:48px">skip_next</span></button>
                </div>
                <button class="icon-btn" onclick="toggleLoop()"><span class="material-symbols-rounded" id="loop">repeat</span></button>
            </div>

            <div style="display:flex; align-items:center; justify-content: space-between;">
                <div style="display:flex; align-items:center; gap:12px; flex:1">
                    <span class="material-symbols-rounded" style="font-size:22px; opacity:0.5">volume_up</span>
                    <input type="range" class="slider" id="volCtrl" min="0" max="1" step="0.05" value="1" style="width: 120px;">
                </div>
                <button class="icon-btn" id="speedBtn" onclick="cycleSpeed()" style="font-family:'Roboto Mono'; font-weight:700; font-size:15px; color:var(--primary)">1.0x</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" onclick="toggleModal(false)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <span class="material-symbols-rounded primary-icon" style="font-size: 60px; margin-bottom: 20px;">info</span>
            <h3>Disclaimer</h3>
            <p>Since we use an unofficial JioSaavn API, it is common to see errors in playback and throttling by the servers. We are always trying make our services useful to you. Thank you for using Aura.</p>
            <button class="btn-filled" onclick="toggleModal(false)">PROCEED</button>
        </div>
    </div>

    <div id="toast">Message</div>
    <audio id="audio" crossorigin="anonymous" preload="auto"></audio>

    <script>
        const API = "https://jiosaavn-api.bhargavtodimela4.workers.dev/api";
        const audio = document.getElementById('audio');
        let queue = [];
        let curIdx = -1;
        let isLoop = false;
        let speeds = [1, 1.25, 1.5, 2, 0.75];
        let sIdx = 0;
        let searchTimer;

        // --- Connection Check ---
        function checkNet() {
            const online = navigator.onLine;
            document.getElementById('netStatus').innerHTML = `<div class="dot ${online ? 'online' : 'offline'}"></div> ${online ? 'Online' : 'Offline'}`;
            document.getElementById('offlineBanner').classList.toggle('show', !online);
        }
        window.addEventListener('online', checkNet);
        window.addEventListener('offline', checkNet);

        // --- AS-YOU-TYPE Search ---
        const searchInp = document.getElementById('searchInp');
        searchInp.oninput = () => {
            clearTimeout(searchTimer);
            if(searchInp.value.length < 2) return;
            searchTimer = setTimeout(() => search(searchInp.value), 10);
        };

        // --- Core Fetcher ---
        async function fetchAura(url) {
            document.getElementById('loader').classList.add('active');
            try {
                const r = await fetch(API + url);
                const d = await r.json();
                return d.data;
            } catch(e) { return null; }
            finally { document.getElementById('loader').classList.remove('active'); }
        }

        async function search(q, el) {
            if(el) {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                searchInp.value = q;
            }
            const data = await fetchAura(`/search/songs?query=${encodeURIComponent(q)}`);
            if(data) {
                queue = data.results.map(s => ({
                    id: s.id, name: clean(s.name), artist: clean(s.artists.primary[0].name),
                    image: s.image[s.image.length-1].url, url: s.downloadUrl[s.downloadUrl.length-1].url
                }));
                renderGrid();
            }
        }

        function renderGrid() {
            document.getElementById('mainGrid').innerHTML = queue.map((s, i) => `
                <div class="card" onclick="playSong(${i})" onmouseenter="prefetch('${s.url}')">
                    <img src="${s.image}" loading="eager">
                    <div class="card-dl" onclick="event.stopPropagation(); downloadManual(${i})">
                        <span class="material-symbols-rounded">download</span>
                    </div>
                    <div class="t">${s.name}</div>
                    <div class="a">${s.artist}</div>
                </div>
            `).join('');
        }

        function prefetch(url) {
            const l = document.createElement('link');
            l.rel = 'prefetch'; l.href = url; l.as = 'audio';
            document.head.appendChild(l);
        }

        // --- Player Core ---
        function playSong(idx) {
            curIdx = idx;
            const s = queue[curIdx];
            audio.src = s.url;
            audio.play().catch(() => showToast("Stream Throttled. Retrying..."));
            document.getElementById('miniPlayer').classList.add('active');
            updateUI(s);
            updateMediaSession(s);
        }

        function updateUI(s) {
            document.getElementById('mArt').src = document.getElementById('fArt').src = s.image;
            document.getElementById('mTitle').innerText = document.getElementById('fTitle').innerText = s.name;
            document.getElementById('mArtist').innerText = document.getElementById('fArtist').innerText = s.artist;
            syncState();
        }

        function togglePlay() {
            if(audio.paused) audio.play(); else audio.pause();
            syncState();
        }

        function syncState() {
            const icon = audio.paused ? 'play_arrow' : 'pause';
            document.getElementById('mPlayIcon').innerText = document.getElementById('fPlayIcon').innerText = icon;
        }

        audio.onplay = syncState; audio.onpause = syncState;

        function next() { if(curIdx < queue.length - 1) playSong(curIdx + 1); }
        function prev() { if(curIdx > 0) playSong(curIdx - 1); }

        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('seeker').value = p;
            document.documentElement.style.setProperty('--progress', p + '%');
            document.getElementById('curT').innerText = fmt(audio.currentTime);
            document.getElementById('totT').innerText = fmt(audio.duration);
        };

        document.getElementById('seeker').oninput = (e) => audio.currentTime = (e.target.value / 100) * audio.duration;
        audio.onended = () => isLoop ? audio.play() : next();

        // --- Features ---
        document.getElementById('volCtrl').oninput = (e) => audio.volume = e.target.value;

        function cycleSpeed() {
            sIdx = (sIdx + 1) % speeds.length;
            audio.playbackRate = speeds[sIdx];
            document.getElementById('speedBtn').innerText = speeds[sIdx] + 'x';
            showToast("Speed: " + speeds[sIdx] + "x");
        }

        function toggleLoop() {
            isLoop = !isLoop;
            document.getElementById('loop').style.color = isLoop ? 'var(--primary)' : 'inherit';
        }

        async function downloadManual(idx) {
            const s = queue[idx];
            showToast("Downloading " + s.name);
            try {
                const r = await fetch(s.url);
                const b = await r.blob();
                const u = URL.createObjectURL(b);
                const a = document.createElement('a');
                a.href = u; a.download = `${s.name} - Aura.mp3`;
                document.body.appendChild(a); a.click();
                URL.revokeObjectURL(u); document.body.removeChild(a);
            } catch(e) { window.open(s.url, '_blank'); }
        }

        function downloadCurrent() { if(curIdx !== -1) downloadManual(curIdx); }

        // --- Utils ---
        function toggleModal(s) { document.getElementById('modal').style.display = s ? 'flex' : 'none'; }
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            document.getElementById('themeIcon').innerText = document.body.classList.contains('light-mode') ? 'light_mode' : 'dark_mode';
        }
        function expandPlayer(s) { document.getElementById('fullPlayer').style.display = s ? 'flex' : 'none'; }
        function fmt(s) { if(isNaN(s)) return '0:00'; const m = Math.floor(s/60); const sc = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sc}`; }
        function clean(h) { const t = document.createElement("textarea"); t.innerHTML = h; return t.value; }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2500); }

        function updateMediaSession(s) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: s.name, artist: s.artist,
                    artwork: [{ src: s.image, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('nexttrack', next);
                navigator.mediaSession.setActionHandler('previoustrack', prev);
            }
        }

        window.onload = () => { checkNet(); search("Trending Hindi Mix"); };
    </script>
</body>
</html>
