<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Ultra â€” Material 3</title>
    
    <!-- Fonts & Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --primary: #D0BCFF;
            --on-primary: #381E72;
            --primary-container: #4F378B;
            --on-primary-container: #EADDFF;
            --surface: #121116;
            --on-surface: #E6E1E5;
            --surface-variant: #49454F;
            --on-surface-variant: #CAC4D0;
            --surface-container: #1D1B20;
            --outline: #938F99;
            --progress: 0%;
        }

        body.light-mode {
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --primary-container: #EADDFF;
            --on-primary-container: #21005D;
            --surface: #FEF7FF;
            --on-surface: #1D1B20;
            --surface-variant: #E7E0EB;
            --on-surface-variant: #49454F;
            --surface-container: #F3EDF7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'Google Sans', sans-serif;
            background-color: var(--surface);
            color: var(--on-surface);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            transition: background 0.4s ease;
        }

        /* --- Modern Loading Bar --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 3px;
            background: transparent; z-index: 9999; overflow: hidden;
            display: none;
        }
        #loader.active { display: block; }
        .loader-fill {
            width: 40%; height: 100%; background: var(--primary);
            position: absolute; left: -40%;
            animation: loading-flow 1s infinite linear;
        }
        @keyframes loading-flow {
            from { left: -40%; } to { left: 100%; }
        }

        /* --- Header & Search --- */
        header { padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; }
        .app-logo { font-size: 24px; font-weight: 700; color: var(--primary); letter-spacing: -1px; }

        main { height: calc(100vh - 150px); overflow-y: auto; padding: 0 20px 150px; scrollbar-width: none; }
        main::-webkit-scrollbar { display: none; }

        .search-area { position: sticky; top: 0; background: var(--surface); padding: 10px 0; z-index: 10; }
        .search-bar {
            background: var(--surface-container); border-radius: 28px;
            height: 56px; display: flex; align-items: center; padding: 0 16px;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-bar:focus-within { background: var(--surface-variant); box-shadow: 0 0 0 2px var(--primary); }
        .search-bar input {
            flex: 1; background: none; border: none; color: var(--on-surface);
            font-size: 16px; margin-left: 12px;
        }

        .tabs { display: flex; gap: 8px; margin-top: 16px; overflow-x: auto; scrollbar-width: none; }
        .tab {
            background: var(--surface-container); padding: 8px 16px; border-radius: 12px;
            font-size: 13px; font-weight: 500; white-space: nowrap; cursor: pointer;
        }
        .tab.active { background: var(--primary); color: var(--on-primary); }

        /* --- Grid --- */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(155px, 1fr));
            gap: 16px; margin-top: 24px;
        }
        .card {
            background: var(--surface-container); border-radius: 20px;
            padding: 12px; cursor: pointer; transition: 0.3s;
            animation: slideIn 0.4s ease-out forwards;
        }
        .card:hover { background: var(--surface-variant); transform: scale(1.02); }
        .card img { width: 100%; aspect-ratio: 1; border-radius: 14px; object-fit: cover; margin-bottom: 10px; }
        .card .title { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .artist { font-size: 12px; opacity: 0.6; margin-top: 2px; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Mini Player --- */
        #miniPlayer {
            position: fixed; bottom: 16px; left: 16px; right: 16px;
            background: var(--primary-container); color: var(--on-primary-container);
            height: 64px; border-radius: 16px; display: flex; align-items: center;
            padding: 0 12px; gap: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            transform: translateY(200%); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000; cursor: pointer;
        }
        #miniPlayer.active { transform: translateY(0); }
        .m-img { width: 44px; height: 44px; border-radius: 8px; object-fit: cover; }
        .m-info { flex: 1; overflow: hidden; }
        .m-info h4 { margin: 0; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* --- Expanded Player (Spotify Style) --- */
        #fullPlayer {
            position: fixed; inset: 0; background: var(--surface);
            z-index: 2001; display: none; flex-direction: column;
            padding: 40px 24px 20px; overflow: hidden;
        }
        .f-header { display: flex; justify-content: space-between; align-items: center; }
        .f-art-wrap {
            flex: 1; display: flex; align-items: center; justify-content: center;
            margin: 40px 0;
        }
        .f-img {
            width: 85vw; max-width: 320px; aspect-ratio: 1;
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            object-fit: cover;
        }

        .f-meta h2 { margin: 0; font-size: 24px; font-weight: 700; }
        .f-meta p { margin: 5px 0 0; font-size: 18px; opacity: 0.7; color: var(--primary); }

        /* --- Controls & Sliders --- */
        .progress-box { margin-top: 30px; }
        .slider {
            -webkit-appearance: none; width: 100%; height: 4px; border-radius: 2px;
            background: linear-gradient(to right, var(--primary) var(--progress), var(--surface-variant) var(--progress));
            outline: none; cursor: pointer;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--primary);
        }

        .f-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 24px; }
        .main-btns { display: flex; align-items: center; gap: 24px; }
        .play-circle {
            width: 72px; height: 72px; border-radius: 50%;
            background: var(--on-primary-container); color: var(--primary-container);
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn { background: none; border: none; color: var(--on-surface); cursor: pointer; padding: 8px; border-radius: 50%; display: flex; }

        /* --- Toast Notification --- */
        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--on-surface); color: var(--surface);
            padding: 10px 20px; border-radius: 24px; font-size: 14px; font-weight: 500;
            opacity: 0; transition: 0.3s; z-index: 3000; pointer-events: none;
        }

        /* Desktop Optimization */
        @media (min-width: 768px) {
            .grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
            .f-img { max-width: 400px; }
        }
    </style>
</head>
<body>

    <div id="loader"><div class="loader-fill"></div></div>

    <header>
        <div class="app-logo">AURA</div>
        <button class="icon-btn" onclick="toggleTheme()"><span class="material-symbols-rounded" id="themeIcon">dark_mode</span></button>
    </header>

    <main>
        <div class="search-area">
            <div class="search-bar">
                <span class="material-symbols-rounded">search</span>
                <input type="text" id="searchInput" placeholder="Search 320kbps music..." autocomplete="off">
            </div>
            <div class="tabs">
                <div class="tab active" onclick="quickSearch('Trending Hindi')">Trending</div>
                <div class="tab" onclick="quickSearch('New Releases')">Latest</div>
                <div class="tab" onclick="quickSearch('Lo-fi Beats')">Lo-fi</div>
                <div class="tab" onclick="quickSearch('Global Hits')">English</div>
                <div class="tab" onclick="quickSearch('Old Classics')">Classics</div>
            </div>
        </div>

        <div class="grid" id="songGrid">
            <!-- Cards will appear here -->
        </div>
    </main>

    <!-- Mini Player -->
    <div id="miniPlayer" onclick="expandPlayer(true)">
        <img src="" id="mImg" class="m-img">
        <div class="m-info">
            <h4 id="mTitle">Nothing Playing</h4>
            <span id="mArtist" style="font-size: 12px; opacity: 0.7;">Select a song</span>
        </div>
        <button class="icon-btn" onclick="event.stopPropagation(); togglePlay()">
            <span class="material-symbols-rounded" id="mPlayIcon" style="font-size: 32px;">play_arrow</span>
        </button>
    </div>

    <!-- Full Screen Player -->
    <div id="fullPlayer">
        <div class="f-header">
            <button class="icon-btn" onclick="expandPlayer(false)"><span class="material-symbols-rounded">expand_more</span></button>
            <span style="font-size: 12px; font-weight: 500; letter-spacing: 1px;">NOW PLAYING</span>
            <button class="icon-btn" onclick="downloadCurrent()"><span class="material-symbols-rounded">download</span></button>
        </div>

        <div class="f-art-wrap">
            <img src="" id="fImg" class="f-img">
        </div>

        <div class="f-meta">
            <h2 id="fTitle">Song Title</h2>
            <p id="fArtist">Artist Name</p>
        </div>

        <div class="progress-box">
            <input type="range" class="slider" id="seeker" value="0">
            <div style="display:flex; justify-content: space-between; margin-top: 10px; font-family:'Roboto Mono'; font-size:12px; opacity:0.6">
                <span id="curTime">0:00</span>
                <span id="totTime">0:00</span>
            </div>
        </div>

        <div class="f-controls">
            <button class="icon-btn" id="shuff"><span class="material-symbols-rounded">shuffle</span></button>
            <div class="main-btns">
                <button class="icon-btn" onclick="prevSong()"><span class="material-symbols-rounded" style="font-size: 36px;">skip_previous</span></button>
                <div class="play-circle" onclick="togglePlay()">
                    <span class="material-symbols-rounded" style="font-size: 48px;" id="fPlayIcon">play_arrow</span>
                </div>
                <button class="icon-btn" onclick="nextSong()"><span class="material-symbols-rounded" style="font-size: 36px;">skip_next</span></button>
            </div>
            <button class="icon-btn" id="loop" onclick="toggleLoop()"><span class="material-symbols-rounded">repeat</span></button>
        </div>
    </div>

    <div id="toast">Message</div>
    <audio id="mainAudio" crossorigin="anonymous"></audio>

    <script>
        const API = "https://jiosaavn-api.bhargavtodimela4.workers.dev/api/search/songs?query=";
        const audio = document.getElementById('mainAudio');
        let queue = [];
        let currentIndex = -1;
        let isLooping = false;
        let searchTimeout;

        // --- Live Search Logic ---
        const searchInput = document.getElementById('searchInput');
        searchInput.oninput = () => {
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();
            if (query.length < 2) return;
            
            document.getElementById('loader').classList.add('active');
            searchTimeout = setTimeout(() => performSearch(query), 500);
        };

        function quickSearch(q) {
            searchInput.value = q;
            performSearch(q);
        }

        async function performSearch(query) {
            try {
                const res = await fetch(API + encodeURIComponent(query));
                const data = await res.json();
                queue = data.data.results.map(s => ({
                    id: s.id,
                    title: clean(s.name),
                    artist: clean(s.artists.primary[0].name),
                    image: s.image[s.image.length-1].url,
                    url: s.downloadUrl[s.downloadUrl.length-1].url
                }));
                renderGrid();
            } catch (e) {
                showToast("Connection error");
            } finally {
                document.getElementById('loader').classList.remove('active');
            }
        }

        function renderGrid() {
            const grid = document.getElementById('songGrid');
            grid.innerHTML = queue.map((s, i) => `
                <div class="card" onclick="playSong(${i})">
                    <img src="${s.image}" loading="lazy">
                    <div class="title">${s.title}</div>
                    <div class="artist">${s.artist}</div>
                </div>
            `).join('');
        }

        // --- Core Player Logic ---
        function playSong(index) {
            currentIndex = index;
            const song = queue[currentIndex];
            audio.src = song.url;
            audio.play();

            // UI Updates
            document.getElementById('miniPlayer').classList.add('active');
            document.getElementById('mImg').src = song.image;
            document.getElementById('mTitle').innerText = song.title;
            document.getElementById('mArtist').innerText = song.artist;

            document.getElementById('fImg').src = song.image;
            document.getElementById('fTitle').innerText = song.title;
            document.getElementById('fArtist').innerText = song.artist;

            updatePlayIcons(true);
            setupMediaSession(song);
        }

        function togglePlay() {
            if (audio.paused) {
                audio.play();
                updatePlayIcons(true);
            } else {
                audio.pause();
                updatePlayIcons(false);
            }
        }

        function updatePlayIcons(isPlaying) {
            const icon = isPlaying ? 'pause' : 'play_arrow';
            document.getElementById('mPlayIcon').innerText = icon;
            document.getElementById('fPlayIcon').innerText = icon;
        }

        function nextSong() {
            if (currentIndex < queue.length - 1) playSong(currentIndex + 1);
        }

        function prevSong() {
            if (currentIndex > 0) playSong(currentIndex - 1);
        }

        // --- Audio Event Listeners ---
        audio.ontimeupdate = () => {
            const prog = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('seeker').value = prog;
            document.documentElement.style.setProperty('--progress', prog + '%');
            document.getElementById('curTime').innerText = formatTime(audio.currentTime);
            document.getElementById('totTime').innerText = formatTime(audio.duration);
        };

        document.getElementById('seeker').oninput = (e) => {
            audio.currentTime = (e.target.value / 100) * audio.duration;
        };

        audio.onended = () => {
            if (isLooping) audio.play();
            else nextSong();
        };

        // --- Functional Features ---
        async function downloadCurrent() {
            if (currentIndex === -1) return;
            const song = queue[currentIndex];
            showToast("Starting High-Quality Download...");
            try {
                const res = await fetch(song.url);
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${song.title} - Aura.mp3`;
                a.click();
            } catch (e) { showToast("Download failed"); }
        }

        function toggleLoop() {
            isLooping = !isLooping;
            document.getElementById('loop').style.color = isLooping ? 'var(--primary)' : 'inherit';
            showToast(isLooping ? "Repeat ON" : "Repeat OFF");
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isL = document.body.classList.contains('light-mode');
            document.getElementById('themeIcon').innerText = isL ? 'light_mode' : 'dark_mode';
        }

        // --- Helpers ---
        function expandPlayer(show) {
            document.getElementById('fullPlayer').style.display = show ? 'flex' : 'none';
        }

        function formatTime(s) {
            if (isNaN(s)) return '0:00';
            const min = Math.floor(s / 60);
            const sec = Math.floor(s % 60).toString().padStart(2, '0');
            return `${min}:${sec}`;
        }

        function clean(text) {
            const div = document.createElement('div');
            div.innerHTML = text;
            return div.textContent || div.innerText || "";
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2500);
        }

        function setupMediaSession(s) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: s.title, artist: s.artist,
                    artwork: [{ src: s.image, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('previoustrack', prevSong);
                navigator.mediaSession.setActionHandler('nexttrack', nextSong);
            }
        }

        // Initial Load
        window.onload = () => quickSearch("Trending Hindi");

        // Keyboard Controls
        window.onkeydown = (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
            if (e.code === 'ArrowRight') audio.currentTime += 5;
            if (e.code === 'ArrowLeft') audio.currentTime -= 5;
        };
    </script>
</body>
</html>
