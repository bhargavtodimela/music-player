<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Music â€” Material 3</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --primary: #D0BCFF;
            --on-primary: #381E72;
            --primary-container: #4F378B;
            --on-primary-container: #EADDFF;
            --surface: #0F0D13;
            --on-surface: #E6E1E5;
            --surface-variant: #49454F;
            --on-surface-variant: #CAC4D0;
            --surface-container: #1D1B20;
            --outline: #938F99;
            --p: 0%;
        }

        body.light-mode {
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --primary-container: #EADDFF;
            --on-primary-container: #21005D;
            --surface: #FEF7FF;
            --on-surface: #1D1B20;
            --surface-variant: #E7E0EB;
            --on-surface-variant: #49454F;
            --surface-container: #F3EDF7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'Google Sans', sans-serif;
            background-color: var(--surface);
            color: var(--on-surface);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            transition: background 0.4s ease;
        }

        /* --- Loading Bar --- */
        .loading-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 3px;
            background: transparent; z-index: 9999; overflow: hidden;
        }
        .loading-bar-inner {
            width: 40%; height: 100%; background: var(--primary);
            position: absolute; left: -40%;
            transition: opacity 0.3s;
        }
        .loading-bar.active .loading-bar-inner {
            animation: loading-flow 1.2s infinite linear;
        }
        @keyframes loading-flow {
            from { left: -40%; }
            to { left: 100%; }
        }

        /* --- Layout --- */
        header { padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 24px; font-weight: 700; color: var(--primary); letter-spacing: -1px; }

        main { 
            height: calc(100vh - 160px); 
            overflow-y: auto; padding: 0 20px; 
            scrollbar-width: none;
        }
        main::-webkit-scrollbar { display: none; }

        .search-box {
            background: var(--surface-container); border-radius: 28px;
            padding: 0 20px; height: 56px; display: flex; align-items: center;
            margin-bottom: 24px; border: 1px solid transparent; transition: 0.3s;
        }
        .search-box:focus-within { border-color: var(--primary); background: var(--surface); }
        .search-box input {
            flex: 1; background: none; border: none; color: var(--on-surface);
            font-size: 16px; margin-left: 12px;
        }

        /* --- Grid --- */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px; padding-bottom: 100px;
        }
        .card {
            background: var(--surface-container); border-radius: 24px;
            padding: 12px; cursor: pointer; transition: 0.3s; position: relative;
            animation: fadeIn 0.5s ease-out forwards; opacity: 0;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card:hover { background: var(--surface-variant); transform: translateY(-5px); }
        .card img { width: 100%; aspect-ratio: 1; border-radius: 16px; object-fit: cover; margin-bottom: 8px; }
        .card .name { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .artist { font-size: 12px; opacity: 0.6; }
        
        .dl-btn {
            position: absolute; bottom: 50px; right: 20px;
            background: var(--primary); color: var(--on-primary);
            width: 36px; height: 36px; border-radius: 50%; display: none;
            align-items: center; justify-content: center;
        }
        .card:hover .dl-btn { display: flex; }

        /* --- Mini Player --- */
        #miniPlayer {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%);
            width: calc(100% - 40px); max-width: 500px;
            background: var(--primary-container); color: var(--on-primary-container);
            border-radius: 20px; padding: 8px 16px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; z-index: 1000;
        }
        #miniPlayer.active { transform: translateX(-50%) translateY(0); }
        .m-art { width: 44px; height: 44px; border-radius: 10px; object-fit: cover; }
        .m-info { flex: 1; overflow: hidden; }
        .m-info h4 { margin: 0; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* --- Full Player --- */
        #fullPlayer {
            position: fixed; inset: 0; background: var(--surface);
            z-index: 2000; display: none; flex-direction: column;
            padding: 40px 24px; overflow: hidden;
        }
        .fp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .fp-art-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            max-height: 40vh; margin-bottom: 30px;
        }
        .fp-art {
            width: 80vw; max-width: 320px; aspect-ratio: 1;
            border-radius: 24px; object-fit: cover;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .fp-meta { margin-bottom: 30px; }
        .fp-meta h2 { margin: 0; font-size: 24px; }
        .fp-meta p { margin: 4px 0 0; font-size: 18px; color: var(--primary); }

        /* --- Controls --- */
        .seeker-box { margin-bottom: 30px; }
        .slider {
            -webkit-appearance: none; width: 100%; height: 4px; border-radius: 2px;
            background: linear-gradient(to right, var(--primary) var(--p), var(--surface-variant) var(--p));
            outline: none; cursor: pointer;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--primary);
        }

        .controls { display: flex; align-items: center; justify-content: space-between; }
        .main-btns { display: flex; align-items: center; gap: 20px; }
        .play-btn { 
            width: 72px; height: 72px; border-radius: 50%;
            background: var(--primary-container); color: var(--on-primary-container);
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn { 
            background: none; border: none; color: var(--on-surface); 
            cursor: pointer; padding: 10px; border-radius: 50%;
        }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--on-surface); color: var(--surface);
            padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s;
            z-index: 3000; pointer-events: none;
        }

        @media (min-width: 768px) {
            .grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .fp-art { max-width: 400px; }
        }
    </style>
</head>
<body>

    <div class="loading-bar" id="loader"><div class="loading-bar-inner"></div></div>

    <header>
        <div class="logo">AURA</div>
        <button class="icon-btn" onclick="toggleTheme()"><span class="material-symbols-rounded" id="themeIcon">dark_mode</span></button>
    </header>

    <main>
        <div class="search-box">
            <span class="material-symbols-rounded">search</span>
            <input type="text" id="searchInp" placeholder="Search 320kbps songs..." autocomplete="off">
        </div>
        <div class="grid" id="grid">
            <!-- Results injected here -->
        </div>
    </main>

    <!-- Mini Player -->
    <div id="miniPlayer" onclick="openFullPlayer()">
        <img src="" id="mArt" class="m-art">
        <div class="m-info">
            <h4 id="mTitle">Not Playing</h4>
            <span id="mArtist" style="font-size: 12px; opacity: 0.8;">-</span>
        </div>
        <button class="icon-btn" onclick="event.stopPropagation(); togglePlay()">
            <span class="material-symbols-rounded" id="mPlayIcon">play_arrow</span>
        </button>
    </div>

    <!-- Full Player -->
    <div id="fullPlayer">
        <div class="fp-header">
            <button class="icon-btn" onclick="closeFullPlayer()"><span class="material-symbols-rounded">expand_more</span></button>
            <span style="font-weight: 500; font-size: 12px; letter-spacing: 2px;">PLAYING FROM SEARCH</span>
            <button class="icon-btn" onclick="downloadCurrent()"><span class="material-symbols-rounded">download</span></button>
        </div>

        <div class="fp-art-container">
            <img src="" id="fArt" class="fp-art">
        </div>

        <div class="fp-meta">
            <h2 id="fTitle">Song Title</h2>
            <p id="fArtist">Artist Name</p>
        </div>

        <div class="seeker-box">
            <input type="range" class="slider" id="seeker" value="0">
            <div style="display:flex; justify-content: space-between; margin-top: 10px; font-family:'Roboto Mono'; font-size:12px; opacity:0.6">
                <span id="curTime">0:00</span>
                <span id="totTime">0:00</span>
            </div>
        </div>

        <div class="controls">
            <button class="icon-btn" onclick="toggleShuffle()"><span class="material-symbols-rounded" id="shuff">shuffle</span></button>
            <div class="main-btns">
                <button class="icon-btn" onclick="prev()"><span class="material-symbols-rounded" style="font-size: 36px;">skip_previous</span></button>
                <div class="play-btn" onclick="togglePlay()">
                    <span class="material-symbols-rounded" style="font-size: 48px;" id="fPlayIcon">play_arrow</span>
                </div>
                <button class="icon-btn" onclick="next()"><span class="material-symbols-rounded" style="font-size: 36px;">skip_next</span></button>
            </div>
            <button class="icon-btn" onclick="toggleRepeat()"><span class="material-symbols-rounded" id="rep">repeat</span></button>
        </div>
    </div>

    <div class="toast" id="toast">Message</div>
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        const API = "https://jiosaavn-api.bhargavtodimela4.workers.dev/api/search/songs?query=";
        const audio = document.getElementById('audio');
        let queue = [];
        let curIdx = -1;
        let isRepeat = false;

        // --- Search Logic (As you type) ---
        const searchInp = document.getElementById('searchInp');
        let debounceTimer;

        searchInp.oninput = () => {
            clearTimeout(debounceTimer);
            document.getElementById('loader').classList.add('active');
            debounceTimer = setTimeout(() => {
                fetchSongs(searchInp.value);
            }, 600);
        };

        async function fetchSongs(q) {
            if(!q) { document.getElementById('loader').classList.remove('active'); return; }
            try {
                const res = await fetch(API + encodeURIComponent(q));
                const json = await res.json();
                queue = json.data.results.map(s => ({
                    id: s.id,
                    title: decodeHtml(s.name),
                    artist: decodeHtml(s.artists.primary[0].name),
                    image: s.image[s.image.length-1].url,
                    url: s.downloadUrl[s.downloadUrl.length-1].url
                }));
                renderGrid();
            } catch (e) { console.error(e); }
            document.getElementById('loader').classList.remove('active');
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = queue.map((s, i) => `
                <div class="card" onclick="playSong(${i})">
                    <img src="${s.image}" loading="lazy">
                    <div class="dl-btn" onclick="event.stopPropagation(); downloadManual('${s.url}', '${s.title}')">
                        <span class="material-symbols-rounded" style="font-size:20px">download</span>
                    </div>
                    <div class="name">${s.title}</div>
                    <div class="artist">${s.artist}</div>
                </div>
            `).join('');
        }

        // --- Player Core ---
        function playSong(idx) {
            curIdx = idx;
            const song = queue[curIdx];
            audio.src = song.url;
            audio.play();
            
            // Update UI
            document.getElementById('miniPlayer').classList.add('active');
            document.getElementById('mArt').src = song.image;
            document.getElementById('mTitle').innerText = song.title;
            document.getElementById('mArtist').innerText = song.artist;
            
            document.getElementById('fArt').src = song.image;
            document.getElementById('fTitle').innerText = song.title;
            document.getElementById('fArtist').innerText = song.artist;
            
            document.getElementById('mPlayIcon').innerText = 'pause';
            document.getElementById('fPlayIcon').innerText = 'pause';

            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title, artist: song.artist,
                    artwork: [{ src: song.image, sizes: '512x512', type: 'image/jpeg' }]
                });
            }
        }

        function togglePlay() {
            if(audio.paused) {
                audio.play();
                document.getElementById('mPlayIcon').innerText = 'pause';
                document.getElementById('fPlayIcon').innerText = 'pause';
            } else {
                audio.pause();
                document.getElementById('mPlayIcon').innerText = 'play_arrow';
                document.getElementById('fPlayIcon').innerText = 'play_arrow';
            }
        }

        function next() { curIdx = (curIdx + 1) % queue.length; playSong(curIdx); }
        function prev() { curIdx = (curIdx - 1 + queue.length) % queue.length; playSong(curIdx); }

        // --- Seek & Time ---
        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('seeker').value = p;
            document.documentElement.style.setProperty('--p', p + '%');
            document.getElementById('curTime').innerText = fmtTime(audio.currentTime);
            document.getElementById('totTime').innerText = fmtTime(audio.duration);
        };

        document.getElementById('seeker').oninput = (e) => {
            audio.currentTime = (e.target.value / 100) * audio.duration;
        };

        audio.onended = () => {
            if(isRepeat) { audio.play(); } else { next(); }
        };

        // --- Features ---
        async function downloadManual(url, name) {
            showToast("Starting download...");
            try {
                const res = await fetch(url);
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = name + ".mp3";
                a.click();
            } catch (e) { showToast("Download failed"); }
        }

        function downloadCurrent() {
            if(curIdx > -1) downloadManual(queue[curIdx].url, queue[curIdx].title);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isL = document.body.classList.contains('light-mode');
            document.getElementById('themeIcon').innerText = isL ? 'light_mode' : 'dark_mode';
        }

        function toggleRepeat() {
            isRepeat = !isRepeat;
            document.getElementById('rep').style.color = isRepeat ? 'var(--primary)' : 'inherit';
            showToast(isRepeat ? "Repeat On" : "Repeat Off");
        }

        // --- Keyboard Shortcuts ---
        window.addEventListener('keydown', (e) => {
            if(e.target.tagName === 'INPUT') return;
            if(e.code === 'Space') { e.preventDefault(); togglePlay(); }
            if(e.code === 'ArrowRight') audio.currentTime += 5;
            if(e.code === 'ArrowLeft') audio.currentTime -= 5;
        });

        // --- Helpers ---
        function openFullPlayer() { document.getElementById('fullPlayer').style.display = 'flex'; }
        function closeFullPlayer() { document.getElementById('fullPlayer').style.display = 'none'; }
        
        function fmtTime(s) {
            if(isNaN(s)) return '0:00';
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60).toString().padStart(2,'0');
            return `${m}:${sec}`;
        }

        function decodeHtml(html) {
            const txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2500);
        }

        // Load trending on start
        window.onload = () => fetchSongs("Trending Hindi");
    </script>
</body>
</html>
