<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JioSaavn â€” Material 3 Final</title>
    
    <!-- Preconnections -->
    <link rel="preconnect" href="https://jiosaavn-api.bhargavtodimela4.workers.dev">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://aac.saavncdn.com" crossorigin>

    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --primary: #D0BCFF;
            --on-primary: #381E72;
            --primary-container: #4F378B;
            --surface: #0F0D13;
            --on-surface: #E6E1E5;
            --surface-variant: #49454F;
            --surface-container: #1D1B20;
            --p: 0%; 
            --v: 80%;
        }

        body.light-mode {
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --primary-container: #EADDFF;
            --surface: #FEF7FF;
            --on-surface: #1D1B20;
            --surface-variant: #E7E0EB;
            --surface-container: #F3EDF7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'Google Sans', sans-serif;
            background-color: var(--surface);
            color: var(--on-surface);
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            transition: background-color 0.4s ease;
            overflow-x: hidden;
        }

        /* Loading Splash */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--surface); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.6s ease, visibility 0.6s;
        }
        .loader-svg { width: 100px; height: 100px; animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } }

        /* App Bar */
        .app-bar {
            width: 100%; max-width: 1000px; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: var(--surface); z-index: 100;
        }
        .app-title { font-size: 24px; font-weight: 500; color: var(--primary); letter-spacing: -0.5px; }

        .icon-btn {
            background: transparent; border: none; color: var(--on-surface);
            cursor: pointer; padding: 12px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .icon-btn:hover { background: var(--surface-variant); }

        /* Search Section */
        .search-area { width: 92%; max-width: 600px; position: relative; border-radius: 32px; overflow: hidden; margin-top: 10px; }
        #searchBox {
            width: 100%; height: 64px; border: none;
            background: var(--surface-container); padding: 0 24px 0 64px;
            font-size: 16px; color: var(--on-surface); outline: none; transition: 0.3s;
        }
        #searchBox:focus { background: var(--surface-variant); }
        .search-icon { position: absolute; left: 24px; top: 20px; color: var(--primary); z-index: 5; }

        .linear-loader {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 3px;
            background: transparent; overflow: hidden; visibility: hidden;
        }
        .linear-loader.active { visibility: visible; }
        .linear-loader::after {
            content: ""; position: absolute; left: -150%; width: 100%; height: 100%;
            background: linear-gradient(to right, transparent, var(--primary), transparent);
            animation: flow 1.5s infinite linear;
        }
        @keyframes flow { 0% { transform: translateX(0); } 100% { transform: translateX(250%); } }

        /* Grid Results */
        .grid {
            width: 92%; max-width: 1100px; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px; padding: 30px 0 250px;
        }

        .card {
            background: var(--surface-container); border-radius: 28px;
            padding: 14px; cursor: pointer; transition: 0.3s;
            opacity: 0; transform: translateY(15px);
        }
        .card.show { animation: cardIn 0.4s ease forwards; }
        @keyframes cardIn { to { opacity: 1; transform: translateY(0); } }
        .card:hover { background: var(--surface-variant); transform: translateY(-4px); }
        .card.playing { border: 1px solid var(--primary); background: var(--primary-container); }
        .card img { width: 100%; aspect-ratio: 1; border-radius: 20px; object-fit: cover; margin-bottom: 12px; }
        .card .title { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .artist { font-size: 12px; opacity: 0.7; margin-top: 4px; }

        /* Player Dock */
        #player {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%) translateY(200%);
            width: 96%; max-width: 850px; 
            background: rgba(29, 27, 32, 0.98); backdrop-filter: blur(30px);
            border-radius: 35px; padding: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.6);
            transition: transform 0.6s cubic-bezier(0.2, 1, 0.2, 1);
            z-index: 1000;
        }
        #player.active { transform: translateX(-50%) translateY(0); }

        .player-top { display: flex; align-items: center; gap: 16px; }
        .p-art { width: 60px; height: 60px; border-radius: 12px; }
        .p-info { flex: 1; min-width: 0; }
        .p-info h4 { margin: 0; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .p-info p { margin: 2px 0 0; font-size: 13px; color: var(--primary); }

        .p-controls { display: flex; align-items: center; gap: 8px; }
        .play-toggle { background: var(--primary); color: var(--on-primary); width: 56px; height: 56px; border-radius: 50%; }

        /* Range Sliders Fixed */
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            flex: 1; height: 6px; border-radius: 3px; outline: none; cursor: pointer;
        }

        .seeker {
            background: linear-gradient(to right, var(--primary) 0%, var(--primary) var(--p), var(--surface-variant) var(--p), var(--surface-variant) 100%);
        }
        
        .vol-slider {
            background: linear-gradient(to right, var(--on-surface) 0%, var(--on-surface) var(--v), var(--surface-variant) var(--v), var(--surface-variant) 100%);
            max-width: 100px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 14px; height: 14px; background: var(--primary); border-radius: 50%;
        }

        .seeker-row { margin-top: 15px; display: flex; align-items: center; gap: 12px; }
        .t-lab { font-size: 11px; font-family: 'Roboto Mono'; opacity: 0.7; width: 45px; }

        .extra { display: flex; align-items: center; gap: 4px; margin-left: 10px; }
        .speed-lab { font-size: 11px; font-weight: 700; color: var(--primary); width: 25px; }

        #toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: var(--on-surface); color: var(--surface);
            padding: 12px 24px; border-radius: 20px; font-weight: 500;
            opacity: 0; transition: 0.3s; z-index: 2000; pointer-events: none;
        }

        @media (max-width: 800px) {
            .grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .extra, .vol-box { display: none; }
        }
    </style>
</head>
<body>

    <div id="splash">
        <div class="loader-svg">
            <svg viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg">
                <circle cx="300" cy="300" r="100" fill="#D0BCFF" />
            </svg>
        </div>
        <p style="margin-top:20px; font-weight: 500; color: var(--primary); letter-spacing: 5px;">MATERIAL MASTER</p>
    </div>

    <div class="app-bar">
        <button class="icon-btn" onclick="toggleTheme()"><span class="material-symbols-rounded" id="modeIcon">dark_mode</span></button>
        <span class="app-title">Explore Music</span>
        <div style="width: 48px;"></div>
    </div>

    <div class="search-area">
        <span class="material-symbols-rounded search-icon">search</span>
        <input id="searchBox" type="text" placeholder="Search 320kbps songs..." autocomplete="off">
        <div id="searchLoader" class="linear-loader"></div>
    </div>

    <div id="grid" class="grid">
        <div style="grid-column: 1/-1; text-align: center; opacity: 0.4; margin-top: 50px;">Search for any song, artist, or album</div>
    </div>

    <!-- Player -->
    <div id="player">
        <div class="player-top">
            <img src="" id="pArt" class="p-art">
            <div class="p-info">
                <h4 id="pTitle">Not Playing</h4>
                <p id="pArtist">-</p>
            </div>
            
            <div class="p-controls">
                <button class="icon-btn" onclick="jump(-10)"><span class="material-symbols-rounded">replay_10</span></button>
                <button class="icon-btn play-toggle" onclick="togglePlay()"><span class="material-symbols-rounded" style="font-size:40px" id="playIcon">play_arrow</span></button>
                <button class="icon-btn" onclick="jump(10)"><span class="material-symbols-rounded">forward_10</span></button>
            </div>

            <div class="extra">
                <button class="icon-btn" onclick="toggleSpeed()"><span class="material-symbols-rounded">speed</span></button>
                <span class="speed-lab" id="speedText">1x</span>
                <button class="icon-btn" onclick="downloadMp3()"><span class="material-symbols-rounded">download</span></button>
            </div>

            <div class="extra vol-box">
                <button class="icon-btn" onclick="toggleMute()"><span class="material-symbols-rounded" id="volIcon">volume_up</span></button>
                <input type="range" class="vol-slider" id="vSeek" min="0" max="100" value="80">
            </div>
        </div>

        <div class="seeker-row">
            <span class="t-lab" id="curT">0:00</span>
            <input type="range" class="seeker" id="pSeek" value="0" min="0" max="100">
            <span class="t-lab" id="totT">0:00</span>
        </div>
    </div>

    <div id="toast">Message</div>
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        const API = "https://jiosaavn-api.bhargavtodimela4.workers.dev/api/search/songs?query=";
        const audio = document.getElementById('audio');
        const searchBox = document.getElementById('searchBox');
        const loader = document.getElementById('searchLoader');
        const grid = document.getElementById('grid');
        
        let currentQueue = [];
        let curIdx = -1;
        let abort = null;
        let speeds = [1, 1.5, 2, 0.5];
        let speedIdx = 0;

        window.onload = () => {
            if(localStorage.getItem('theme') === 'light') toggleTheme();
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').style.display = 'none', 800);
            }, 1000);
            updateVolFill(80);
        };

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isL = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isL ? 'light' : 'dark');
            document.getElementById('modeIcon').innerText = isL ? 'light_mode' : 'dark_mode';
        }

        searchBox.oninput = () => {
            const q = searchBox.value.trim();
            if(q.length < 2) return;
            clearTimeout(window.st);
            window.st = setTimeout(() => searchSongs(q), 500);
        };

        async function searchSongs(q) {
            if(abort) abort.abort();
            abort = new AbortController();
            loader.classList.add('active');
            try {
                const res = await fetch(API + encodeURIComponent(q), { signal: abort.signal });
                const json = await res.json();
                currentQueue = json.data.results.map(s => ({
                    id: s.id, title: s.name, artist: s.artists.primary[0].name,
                    image: s.image[s.image.length-1].url, 
                    url: s.downloadUrl[s.downloadUrl.length-1].url 
                }));
                renderGrid(currentQueue);
                loader.classList.remove('active');
            } catch(e) { loader.classList.remove('active'); }
        }

        function renderGrid(list) {
            grid.innerHTML = list.length ? list.map((s, i) => `
                <div class="card ${audio.src === s.url ? 'playing' : ''}" onclick="playSong(${i})">
                    <img src="${s.image}" loading="lazy">
                    <div class="title">${s.title}</div>
                    <div class="artist">${s.artist}</div>
                </div>
            `).join('') : '<p style="grid-column:1/-1;text-align:center;opacity:0.4">No results found</p>';
            grid.querySelectorAll('.card').forEach((c, i) => setTimeout(() => c.classList.add('show'), i * 30));
        }

        function playSong(idx) {
            curIdx = idx;
            const s = currentQueue[curIdx];
            audio.src = s.url;
            audio.play();
            document.getElementById('player').classList.add('active');
            document.getElementById('pArt').src = s.image;
            document.getElementById('pTitle').innerText = s.title;
            document.getElementById('pArtist').innerText = s.artist;
            document.getElementById('playIcon').innerText = 'pause';
            document.querySelectorAll('.card').forEach(c => c.classList.remove('playing'));
            updateMedia(s);
        }

        function togglePlay() {
            if(audio.paused) { audio.play(); document.getElementById('playIcon').innerText = 'pause'; }
            else { audio.pause(); document.getElementById('playIcon').innerText = 'play_arrow'; }
        }

        function jump(secs) { audio.currentTime += secs; }

        function toggleSpeed() {
            speedIdx = (speedIdx + 1) % speeds.length;
            audio.playbackRate = speeds[speedIdx];
            document.getElementById('speedText').innerText = speeds[speedIdx] + 'x';
        }

        const vSeek = document.getElementById('vSeek');
        vSeek.oninput = (e) => {
            const v = e.target.value;
            audio.volume = v / 100;
            updateVolFill(v);
        };

        function updateVolFill(v) {
            document.documentElement.style.setProperty('--v', v + '%');
            document.getElementById('volIcon').innerText = v == 0 ? 'volume_off' : 'volume_up';
        }

        function toggleMute() {
            audio.muted = !audio.muted;
            document.getElementById('volIcon').innerText = audio.muted ? 'volume_off' : 'volume_up';
        }

        async function downloadMp3() {
            if(!audio.src) return;
            showToast("Downloading 320kbps MP3...");
            try {
                const res = await fetch(audio.src);
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = document.getElementById('pTitle').innerText + ".mp3";
                a.click();
            } catch(e) { showToast("Download failed"); }
        }

        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100 || 0;
            const seeker = document.getElementById('pSeek');
            seeker.value = p;
            document.documentElement.style.setProperty('--p', p + '%');
            document.getElementById('curT').innerText = fmt(audio.currentTime);
            document.getElementById('totT').innerText = fmt(audio.duration);
        };

        document.getElementById('pSeek').oninput = (e) => {
            const val = e.target.value;
            audio.currentTime = (val / 100) * audio.duration;
            document.documentElement.style.setProperty('--p', val + '%');
        };

        audio.onended = () => { if(curIdx < currentQueue.length - 1) playSong(curIdx + 1); };

        const fmt = (s) => isNaN(s) ? '0:00' : Math.floor(s/60) + ':' + Math.floor(s%60).toString().padStart(2,'0');
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000); }

        function updateMedia(s) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: s.title, artist: s.artist,
                    artwork: [{ src: s.image, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
            }
        }
    </script>
</body>
</html>
