<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JioSaavn Player â€” Material Design</title>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            /* Material 3 Dark Palette (Default) */
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary-container: #333333;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-surface-container: #211F26;
            --ripple-color: rgba(255, 255, 255, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.light-mode {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-on-surface: #1D1B20;
            --md-sys-color-surface-variant: #E7E0EB;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-surface-container: #F3EDF7;
            --ripple-color: rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 120px;
            transition: background 0.3s;
        }

        /* Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple-element {
            position: absolute;
            background: var(--ripple-color);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }
        @keyframes ripple-animation {
            to { transform: scale(4); opacity: 0; }
        }

        /* App Bar */
        .header-container {
            width: 100%;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
        }

        h1 {
            font-family: 'Google Sans', sans-serif;
            font-size: 24px;
            font-weight: 400;
            margin: 0;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .icon-btn:hover { background: var(--md-sys-color-surface-variant); }

        /* Search Bar */
        .search-wrapper {
            width: 90%;
            max-width: 720px;
            margin: 10px 0 24px 0;
            position: relative;
        }

        #searchBox {
            width: 100%;
            height: 56px;
            border-radius: 28px;
            border: none;
            background: var(--md-sys-color-surface-container);
            padding: 0 24px 0 56px;
            font-size: 16px;
            color: var(--md-sys-color-on-surface);
            outline: none;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #searchBox:focus {
            background: var(--md-sys-color-surface-variant);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 16px;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Segmented Tabs */
        .nav-tabs {
            display: flex;
            background: var(--md-sys-color-surface-container);
            border-radius: 20px;
            padding: 4px;
            margin-bottom: 24px;
            gap: 4px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface-variant);
            padding: 10px 24px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 16px;
            transition: var(--transition);
            font-family: 'Google Sans', sans-serif;
        }

        .tab-btn.active {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        /* Grid & Cards */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            width: 90%;
            max-width: 1200px;
        }

        .card {
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 24px;
            padding: 12px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .card:hover {
            background: var(--md-sys-color-surface-variant);
            transform: translateY(-4px);
        }

        .card img {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 16px;
            object-fit: cover;
            margin-bottom: 12px;
        }

        .card-title {
            font-weight: 500;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-artist {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .card-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            transition: 0.2s;
        }

        .card:hover .card-actions { opacity: 1; }

        .mini-fab {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Floating Player */
        #playerBox {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            width: 94%;
            max-width: 800px;
            background: var(--md-sys-color-surface-container);
            padding: 16px;
            border-radius: 28px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #playerBox.active { transform: translateX(-50%) translateY(0); }

        .player-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .player-thumb {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            object-fit: cover;
        }

        .player-info { flex: 1; min-width: 0; }

        .player-info h4 { margin: 0; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-info p { margin: 0; font-size: 13px; color: var(--md-sys-color-primary); }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Material Native Audio Styling */
        audio {
            width: 100%;
            height: 40px;
            filter: grayscale(1) invert(0);
        }
        body:not(.light-mode) audio { filter: invert(1) hue-rotate(180deg); }

        /* Status Messages */
        .status-msg {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Toasts */
        #toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
        }

        .toast {
            background: var(--md-sys-color-on-surface);
            color: var(--md-sys-color-surface);
            padding: 12px 24px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .view-section.hidden { display: none; }

        @media (max-width: 600px) {
            .grid-container { grid-template-columns: repeat(2, 1fr); }
            h1 { font-size: 20px; }
            .player-controls .icon-btn:not(.play-btn) { display: none; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="header-container">
        <button class="icon-btn ripple" onclick="toggleTheme()" title="Toggle Theme">
            <span class="material-symbols-rounded" id="themeIcon">dark_mode</span>
        </button>
        <h1>JioSaavn Material</h1>
        <button class="icon-btn ripple" onclick="switchTab('queue')">
            <span class="material-symbols-rounded">queue_music</span>
        </button>
    </div>

    <div class="search-wrapper">
        <span class="material-symbols-rounded search-icon">search</span>
        <input id="searchBox" type="text" placeholder="Search for songs, artists..." autocomplete="off" />
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active ripple" onclick="switchTab('search')">Search</button>
        <button class="tab-btn ripple" onclick="switchTab('favorites')">Favorites</button>
        <button class="tab-btn ripple" onclick="switchTab('queue')">Queue</button>
    </div>

    <!-- Search Section -->
    <div id="searchView" class="view-section">
        <div id="searchResults" class="grid-container">
            <div class="status-msg">Search for music to get started</div>
        </div>
    </div>

    <!-- Favorites Section -->
    <div id="favoritesView" class="view-section hidden">
        <div id="favResults" class="grid-container"></div>
    </div>

    <!-- Queue Section -->
    <div id="queueView" class="view-section hidden">
        <div id="queueResults" class="grid-container"></div>
    </div>

    <!-- Player Box -->
    <div id="playerBox">
        <div class="player-content">
            <img id="playerThumb" class="player-thumb" src="https://placehold.co/100" alt="Album Art">
            <div class="player-info">
                <h4 id="currentTitle">Not Playing</h4>
                <p id="currentArtist">-</p>
            </div>
            <div class="player-controls">
                <button class="icon-btn ripple" onclick="playPrev()">
                    <span class="material-symbols-rounded">skip_previous</span>
                </button>
                <button class="icon-btn ripple" onclick="playNext()">
                    <span class="material-symbols-rounded">skip_next</span>
                </button>
                <button id="playerFavBtn" class="icon-btn ripple" onclick="togglePlayerFavorite()">
                    <span class="material-symbols-rounded">favorite</span>
                </button>
            </div>
        </div>
        <audio id="audioPlayer" controls controlsList="nodownload"></audio>
    </div>

    <script>
        const API_BASE = "https://jiosaavn-api.bhargavtodimela4.workers.dev/api/search/songs?query=";
        const STORAGE_FAVS = "jiosaavn_favorites_v2";
        const STORAGE_THEME = "jiosaavn_theme_v2";

        let currentSongData = null;
        let queue = [];
        let queueIndex = -1;
        let searchTimer;

        // Elements
        const searchBox = document.getElementById("searchBox");
        const searchResults = document.getElementById("searchResults");
        const favResults = document.getElementById("favResults");
        const queueResults = document.getElementById("queueResults");
        const audioPlayer = document.getElementById("audioPlayer");
        const playerBox = document.getElementById("playerBox");
        const themeIcon = document.getElementById("themeIcon");

        // Initialization
        window.onload = () => {
            initTheme();
            setupRipples();
        };

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem(STORAGE_THEME, isLight ? 'light' : 'dark');
            themeIcon.innerText = isLight ? 'light_mode' : 'dark_mode';
        }

        function initTheme() {
            const saved = localStorage.getItem(STORAGE_THEME);
            if (saved === 'light') toggleTheme();
        }

        // Tab System
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));

            event.target.classList.add('active');
            document.getElementById(`${tab}View`).classList.remove('hidden');

            if (tab === 'favorites') renderFavorites();
            if (tab === 'queue') renderQueue();
        }

        // Search Logic
        searchBox.addEventListener("input", (e) => {
            clearTimeout(searchTimer);
            const query = e.target.value.trim();
            if (!query) return;
            searchTimer = setTimeout(() => performSearch(query), 500);
        });

        async function performSearch(query) {
            searchResults.innerHTML = '<div class="status-msg">Searching...</div>';
            try {
                const res = await fetch(API_BASE + encodeURIComponent(query));
                const json = await res.json();
                const results = json.data.results || [];
                
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="status-msg">No results found</div>';
                    return;
                }

                const songs = results.map(s => ({
                    id: s.id,
                    title: s.name,
                    artist: s.artists.primary.map(a => a.name).join(", "),
                    image: s.image[2].url,
                    audio: s.downloadUrl[s.downloadUrl.length - 1].url
                }));

                renderGrid(songs, searchResults);
            } catch (e) {
                searchResults.innerHTML = '<div class="status-msg">Error loading songs</div>';
            }
        }

        // Render Helpers
        function renderGrid(songs, container) {
            const favs = getFavorites();
            container.innerHTML = songs.map(song => {
                const isFav = favs.some(f => f.id === song.id);
                return `
                <div class="card ripple" onclick="playSong('${song.id}', ${JSON.stringify(song).replace(/"/g, '&quot;')})">
                    <div class="card-actions">
                        <button class="mini-fab" onclick="event.stopPropagation(); addToQueue(${JSON.stringify(song).replace(/"/g, '&quot;')})">
                            <span class="material-symbols-rounded">add</span>
                        </button>
                        <button class="mini-fab" style="background: ${isFav ? '#ff4d4d' : 'var(--md-sys-color-primary)'}" onclick="event.stopPropagation(); toggleLike('${song.id}', ${JSON.stringify(song).replace(/"/g, '&quot;')})">
                            <span class="material-symbols-rounded">${isFav ? 'favorite' : 'heart_plus'}</span>
                        </button>
                    </div>
                    <img src="${song.image}" loading="lazy">
                    <div class="card-title">${song.title}</div>
                    <div class="card-artist">${song.artist}</div>
                </div>
                `;
            }).join('');
            setupRipples();
        }

        // Player Controls
        function playSong(id, song) {
            currentSongData = song;
            if (!queue.some(s => s.id === id)) {
                queue.push(song);
                queueIndex = queue.length - 1;
            } else {
                queueIndex = queue.findIndex(s => s.id === id);
            }

            document.getElementById("currentTitle").innerText = song.title;
            document.getElementById("currentArtist").innerText = song.artist;
            document.getElementById("playerThumb").src = song.image;
            audioPlayer.src = song.audio;
            
            playerBox.classList.add("active");
            audioPlayer.play();
            updatePlayerHeart();
        }

        function playNext() {
            if (queueIndex < queue.length - 1) {
                queueIndex++;
                playSong(queue[queueIndex].id, queue[queueIndex]);
            }
        }

        function playPrev() {
            if (queueIndex > 0) {
                queueIndex--;
                playSong(queue[queueIndex].id, queue[queueIndex]);
            }
        }

        audioPlayer.onended = () => playNext();

        // Queue & Favorites
        function addToQueue(song) {
            queue.push(song);
            showToast("Added to queue");
        }

        function getFavorites() {
            return JSON.parse(localStorage.getItem(STORAGE_FAVS)) || [];
        }

        function toggleLike(id, song) {
            let favs = getFavorites();
            const idx = favs.findIndex(f => f.id === id);
            if (idx > -1) {
                favs.splice(idx, 1);
                showToast("Removed from favorites");
            } else {
                favs.push(song);
                showToast("Added to favorites");
            }
            localStorage.setItem(STORAGE_FAVS, JSON.stringify(favs));
            
            // Refresh current view
            if (!document.getElementById('favoritesView').classList.contains('hidden')) renderFavorites();
            else performSearch(searchBox.value);
            updatePlayerHeart();
        }

        function renderFavorites() {
            const favs = getFavorites();
            if (favs.length === 0) favResults.innerHTML = '<div class="status-msg">No favorites yet</div>';
            else renderGrid(favs, favResults);
        }

        function renderQueue() {
            if (queue.length === 0) queueResults.innerHTML = '<div class="status-msg">Queue is empty</div>';
            else renderGrid(queue, queueResults);
        }

        function updatePlayerHeart() {
            if (!currentSongData) return;
            const isFav = getFavorites().some(f => f.id === currentSongData.id);
            const btn = document.getElementById("playerFavBtn");
            btn.style.color = isFav ? "#ff4d4d" : "inherit";
            btn.querySelector('span').innerText = isFav ? 'favorite' : 'heart_plus';
        }

        function togglePlayerFavorite() {
            if (currentSongData) toggleLike(currentSongData.id, currentSongData);
        }

        // Material UI Ripple Logic
        function setupRipples() {
            document.querySelectorAll('.ripple').forEach(button => {
                button.onmousedown = function(e) {
                    const rect = this.getBoundingClientRect();
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple-element';
                    ripple.style.left = `${e.clientX - rect.left}px`;
                    ripple.style.top = `${e.clientY - rect.top}px`;
                    ripple.style.width = ripple.style.height = `${Math.max(rect.width, rect.height)}px`;
                    this.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                }
            });
        }

        function showToast(msg) {
            const container = document.getElementById("toast-container");
            const t = document.createElement("div");
            t.className = "toast";
            t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
